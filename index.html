<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ancient Tome Reader</title>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f5e7d0;
            --text-color: #3a3226;
            --page-color: #f8f1e0;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --highlight-color: #e8d9b5;
            --nav-btn-color: #5d4c3a;
            --page-edge-color: #e8d9b5;
            --book-spine-color: #3a3226;
            --typing-speed: 30ms;
        }

        .night-mode {
            --bg-color: #1a1a1a;
            --text-color: #d9d1c7;
            --page-color: #2a2620;
            --shadow-color: rgba(0, 0, 0, 0.6);
            --highlight-color: #3a3226;
            --nav-btn-color: #8a7a66;
            --page-edge-color: #3a3226;
            --book-spine-color: #5d4c3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Caveat', cursive;
            background-color: var(--bg-color);
            color: var(--text-color);
            background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M0 0 L100 0 L100 100 L0 100 Z" fill="none" stroke="%233a3226" stroke-width="0.5" stroke-opacity="0.1" /></svg>');
            background-size: 200px;
            overflow-x: hidden;
            transition: background-color 0.5s, color 0.5s;
            touch-action: pan-y;
        }

        .book-container {
            position: relative;
            width: 90%;
            max-width: 900px;
            height: 80vh;
            margin: 5vh auto;
            perspective: 2000px;
        }

        .book {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            will-change: transform;
        }

        .page {
            position: absolute;
            width: 50%;
            height: 100%;
            top: 0;
            left: 50%;
            transform-origin: left center;
            transform-style: preserve-3d;
            transition: transform 1s cubic-bezier(0.25, 0.1, 0.25, 1);
            background: linear-gradient(90deg, var(--page-color) 95%, var(--page-edge-color) 100%);
            background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M0 0 L100 0 L100 100 L0 100 Z" fill="none" stroke="%233a3226" stroke-width="0.5" stroke-opacity="0.1" /></svg>');
            background-size: 200px;
            box-shadow: 
                inset 5px 0 15px rgba(0,0,0,0.1),
                inset -1px 0 2px rgba(255,255,255,0.5),
                0 0 10px rgba(0,0,0,0.2);
            overflow: hidden;
            border-radius: 2px 8px 8px 2px;
            will-change: transform;
            backface-visibility: hidden;
        }

        .page::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 30px;
            height: 100%;
            background: linear-gradient(90deg, rgba(0,0,0,0.05), transparent);
            pointer-events: none;
        }

        .page-content {
            padding: 40px;
            height: 100%;
            overflow-y: auto;
            opacity: 0;
            transition: opacity 0.5s;
            position: relative;
            font-size: 1em;
            line-height: 1.6;
        }

        .page-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0,0,0,0.03) 1px, transparent 1px),
                radial-gradient(circle at 80% 70%, rgba(0,0,0,0.03) 1px, transparent 1px);
            background-size: 100px 100px;
            pointer-events: none;
        }

        .page.active .page-content {
            opacity: 1;
        }

        .page-number {
            position: absolute;
            bottom: 10px;
            right: 20px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.7;
            cursor: pointer;
            z-index: 10;
        }

        .page-number:hover {
            text-decoration: underline;
        }

        .page-cover {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: var(--book-spine-color);
            background-image: linear-gradient(to right, var(--book-spine-color), var(--nav-btn-color));
            color: var(--highlight-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5);
            border-radius: 5px 15px 15px 5px;
            z-index: 10;
        }

        .page-cover h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .page-cover p {
            font-size: 1.5rem;
            margin-bottom: 30px;
        }

        .open-book-btn {
            background-color: var(--highlight-color);
            color: var(--text-color);
            border: none;
            padding: 10px 20px;
            font-family: 'Caveat', cursive;
            font-size: 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .open-book-btn:hover {
            background-color: var(--page-edge-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 80px;
            background-color: var(--nav-btn-color);
            color: var(--highlight-color);
            border: none;
            font-size: 24px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .nav-btn:hover {
            opacity: 1;
        }

        .prev-btn {
            left: 10px;
        }

        .next-btn {
            right: 10px;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
            background-color: rgba(58, 50, 38, 0.8);
            padding: 10px;
            border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--highlight-color);
            color: var(--nav-btn-color);
            border: none;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .toc-btn::after {
            content: "â‰¡";
        }

        .bookmark-btn::after {
            content: "ðŸ”–";
        }

        .font-increase-btn::after {
            content: "A+";
        }

        .font-decrease-btn::after {
            content: "A-";
        }

        .mode-btn::after {
            content: "â˜½";
        }

        .night-mode .mode-btn::after {
            content: "â˜€";
        }

        .home-btn::after {
            content: "âŒ‚";
        }

        .resume-btn::after {
            content: "â†»";
        }

        .progress-btn::after {
            content: "âž”";
        }

        .toc-panel {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background-color: var(--page-color);
            box-shadow: 2px 0 10px var(--shadow-color);
            z-index: 2000;
            transition: transform 0.3s;
            padding: 20px;
            overflow-y: auto;
        }

        .toc-panel.active {
            transform: translateX(300px);
        }

        .toc-item {
            padding: 10px 0;
            border-bottom: 1px dashed rgba(58, 50, 38, 0.3);
            cursor: pointer;
        }

        .toc-item:hover {
            color: var(--highlight-color);
        }

        .toc-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
        }

        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }

        .mobile-nav-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--nav-btn-color);
            color: var(--highlight-color);
            border: none;
            font-size: 20px;
            margin: 0 10px;
            cursor: pointer;
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background-color: var(--text-color);
            animation: blink 1s infinite;
            vertical-align: middle;
            margin-left: 2px;
        }

        .page-corner {
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 30px 30px 0;
            border-color: transparent var(--page-edge-color) transparent transparent;
            z-index: 5;
        }

        .page.flipping .page-corner {
            animation: cornerFold 1s forwards;
        }

        @keyframes cornerFold {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(-45deg); }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Page flip animation classes */
        .page.flipping {
            transform: rotateY(-160deg);
            z-index: 100;
            box-shadow: 
                -5px 5px 20px var(--shadow-color),
                -10px 0 30px rgba(0,0,0,0.2);
        }

        .page.flipped {
            transform: rotateY(-180deg);
            z-index: 0;
        }

        .page.active {
            z-index: 10;
        }

        /* Book spine effect */
        .book::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 10px;
            height: 100%;
            background: linear-gradient(to right, var(--book-spine-color), var(--nav-btn-color), var(--book-spine-color));
            transform: translateX(-50%);
            z-index: 5;
            border-radius: 2px;
        }

        /* Loading animation */
        .loading-parchment {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--page-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .loading-parchment.active {
            opacity: 0.8;
        }

        .loading-parchment::after {
            content: '...';
            font-size: 3rem;
            color: var(--text-color);
            animation: loadingDots 1.5s infinite;
        }

        @keyframes loadingDots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Ink stain effect */
        .ink-stain {
            position: absolute;
            opacity: 0.05;
            background-color: var(--text-color);
            border-radius: 50%;
            pointer-events: none;
        }

        /* Page edge click areas */
        .page-left-edge {
            position: absolute;
            left: 0;
            top: 0;
            width: 20%;
            height: 100%;
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23ffffff" d="M15.41 16.58L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.42z"/></svg>'), auto;
            z-index: 20;
        }

        .page-right-edge {
            position: absolute;
            right: 0;
            top: 0;
            width: 20%;
            height: 100%;
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23ffffff" d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>'), auto;
            z-index: 20;
        }

        /* Progress bar */
        .progress-container {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 600px;
            height: 6px;
            background-color: rgba(58, 50, 38, 0.2);
            border-radius: 3px;
            z-index: 1000;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--nav-btn-color);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s;
        }

        /* Page jump modal */
        .page-jump-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--page-color);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            z-index: 3000;
            display: none;
        }

        .page-jump-modal h3 {
            margin-bottom: 15px;
        }

        .page-jump-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--nav-btn-color);
            border-radius: 5px;
            font-family: inherit;
            font-size: 16px;
        }

        .page-jump-buttons {
            display: flex;
            justify-content: space-between;
        }

        .page-jump-button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            background-color: var(--nav-btn-color);
            color: var(--highlight-color);
            cursor: pointer;
        }

        .page-jump-button.cancel {
            background-color: #ccc;
            color: #333;
        }

        /* Settings panel */
        .settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--page-color);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            z-index: 3000;
            display: none;
            width: 90%;
            max-width: 400px;
        }

        .settings-panel h3 {
            margin-bottom: 15px;
            border-bottom: 1px solid var(--nav-btn-color);
            padding-bottom: 10px;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
        }

        .setting-item input[type="range"] {
            width: 100%;
        }

        .settings-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .settings-button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            background-color: var(--nav-btn-color);
            color: var(--highlight-color);
            cursor: pointer;
        }

        .settings-button.cancel {
            background-color: #ccc;
            color: #333;
        }

        @media (max-width: 768px) {
            .book-container {
                width: 100%;
                height: 90vh;
                margin: 5vh auto;
            }

            .page-content {
                padding: 20px;
            }

            .nav-btn {
                display: none;
            }

            .mobile-nav {
                display: flex;
            }

            .controls {
                bottom: 10px;
                padding: 8px;
            }

            .control-btn {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }

            .page::after {
                width: 15px;
            }

            .progress-container {
                bottom: 60px;
                width: 90%;
            }
        }

        /* Accessibility focus styles */
        button:focus {
            outline: 2px solid var(--highlight-color);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="book-container">
        <div class="book">
            <!-- Cover Page -->
            <div class="page page-cover active" id="cover">
                <h1>The Ancient Tome</h1>
                <p>Mysteries of a Forgotten Era</p>
                <button class="open-book-btn" aria-label="Open book">Open Book</button>
            </div>

            <!-- Example Pages -->
            <div class="page" id="page1">
                <div class="page-left-edge"></div>
                <div class="page-right-edge"></div>
                <div class="page-corner"></div>
                <div class="loading-parchment"></div>
                <div class="page-content" data-typing>
                    <h2>Chapter One: The Beginning</h2>
                    <p>In the days of old, when the world was young and magic flowed like rivers through the land, there existed a kingdom hidden among the clouds. Its people lived in harmony with the elements, drawing power from the very air they breathed.</p>
                    <p>The wise rulers of this kingdom kept a sacred tome, filled with knowledge from ages past. This book, bound in dragonhide and inked with starlight, contained secrets that could shape the destiny of worlds.</p>
                </div>
                <div class="page-number">1</div>
            </div>

            <div class="page" id="page2">
                <div class="page-left-edge"></div>
                <div class="page-right-edge"></div>
                <div class="page-corner"></div>
                <div class="loading-parchment"></div>
                <div class="page-content" data-typing>
                    <h2>The First Prophecy</h2>
                    <p>As foretold by the seers of yore, a time would come when the balance would shift. The stars would align in the constellation of the Serpent, and the gates between worlds would tremble.</p>
                    <p>"When the silver moon eclipses the golden sun, and the seven bells toll in the hollow tower, the keeper of the tome shall rise from among the unmarked graves."</p>
                    <p>This prophecy, written in the tongue of the ancients, was said to hold the key to preventing the great unraveling.</p>
                </div>
                <div class="page-number">2</div>
            </div>

            <div class="page" id="page3">
                <div class="page-left-edge"></div>
                <div class="page-right-edge"></div>
                <div class="page-corner"></div>
                <div class="loading-parchment"></div>
                <div class="page-content" data-typing>
                    <h2>The Lost Artifacts</h2>
                    <p>Scattered across the realms were seven artifacts of immense power:</p>
                    <ol>
                        <li>The Crown of Twilight</li>
                        <li>The Scepter of the Deep</li>
                        <li>The Chalice of Dawn</li>
                        <li>The Mirror of Echoes</li>
                        <li>The Locket of Shadows</li>
                        <li>The Key of the Last Door</li>
                        <li>The Tome of Endings (this very book)</li>
                    </ol>
                    <p>When brought together, these items could either mend the fabric of reality or tear it asunder, depending on the hands that wielded them.</p>
                </div>
                <div class="page-number">3</div>
            </div>

            <div class="page" id="page4">
                <div class="page-left-edge"></div>
                <div class="page-right-edge"></div>
                <div class="page-corner"></div>
                <div class="loading-parchment"></div>
                <div class="page-content" data-typing>
                    <h2>The Keepers</h2>
                    <p>For generations, a secret order guarded the tome, passing it down from master to apprentice in an unbroken chain. Each keeper added their own knowledge to its pages, but also their own protections.</p>
                    <p>The current keeper, an old woman who lived in the ruins of the cloud kingdom, could often be heard whispering to the book as if it could answer. Some said it did.</p>
                    <p>Her eyes, milky with age but sharp with wisdom, had seen the patterns of fate woven through time. She knew the hour was approaching when the tome would need to choose its next bearer.</p>
                </div>
                <div class="page-number">4</div>
            </div>
        </div>
    </div>

    <!-- Desktop Navigation -->
    <button class="nav-btn prev-btn" aria-label="Previous page">â€¹</button>
    <button class="nav-btn next-btn" aria-label="Next page">â€º</button>

    <!-- Mobile Navigation -->
    <div class="mobile-nav">
        <button class="mobile-nav-btn prev-btn" aria-label="Previous page">â€¹</button>
        <button class="mobile-nav-btn next-btn" aria-label="Next page">â€º</button>
    </div>

    <!-- Controls -->
    <div class="controls">
        <button class="control-btn toc-btn" title="Table of Contents" aria-label="Table of contents"></button>
        <button class="control-btn bookmark-btn" title="Bookmark Page" aria-label="Bookmark page"></button>
        <button class="control-btn font-increase-btn" title="Increase Font Size" aria-label="Increase font size"></button>
        <button class="control-btn font-decrease-btn" title="Decrease Font Size" aria-label="Decrease font size"></button>
        <button class="control-btn mode-btn" title="Toggle Day/Night Mode" aria-label="Toggle night mode"></button>
        <button class="control-btn home-btn" title="Return to Cover" aria-label="Return to cover"></button>
        <button class="control-btn resume-btn" title="Resume Reading" aria-label="Resume reading"></button>
        <button class="control-btn progress-btn" title="Jump to Page" aria-label="Jump to page"></button>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-bar"></div>
    </div>

    <!-- Table of Contents -->
    <div class="toc-panel">
        <div class="toc-close" aria-label="Close table of contents">Ã—</div>
        <h3>Table of Contents</h3>
        <div class="toc-item" data-page="cover">Cover</div>
        <div class="toc-item" data-page="page1">Chapter 1: The Beginning</div>
        <div class="toc-item" data-page="page2">The First Prophecy</div>
        <div class="toc-item" data-page="page3">The Lost Artifacts</div>
        <div class="toc-item" data-page="page4">The Keepers</div>
    </div>

    <!-- Page Jump Modal -->
    <div class="page-jump-modal">
        <h3>Jump to Page</h3>
        <input type="number" class="page-jump-input" min="1" max="4" placeholder="Enter page number">
        <div class="page-jump-buttons">
            <button class="page-jump-button cancel">Cancel</button>
            <button class="page-jump-button go">Go</button>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel">
        <h3>Reading Settings</h3>
        <div class="setting-item">
            <label for="typing-speed">Typing Speed</label>
            <input type="range" id="typing-speed" min="10" max="100" value="30">
            <div class="speed-value">Medium</div>
        </div>
        <div class="setting-item">
            <label for="animation-speed">Page Turn Speed</label>
            <input type="range" id="animation-speed" min="500" max="2000" step="100" value="1000">
            <div class="speed-value">Normal</div>
        </div>
        <div class="settings-buttons">
            <button class="settings-button cancel">Cancel</button>
            <button class="settings-button save">Save Settings</button>
        </div>
    </div>

    <audio id="pageTurnSound" src="https://assets.mixkit.co/sfx/preview/mixkit-book-page-turn-1563.mp3" preload="auto"></audio>
    <audio id="paperSound" src="https://assets.mixkit.co/sfx/preview/mixkit-paper-whirl-1487.mp3" preload="auto"></audio>
    <audio id="typingSound" src="https://assets.mixkit.co/sfx/preview/mixkit-keyboard-typing-1386.mp3" preload="auto"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const bookContainer = document.querySelector('.book-container');
            const book = document.querySelector('.book');
            const pages = document.querySelectorAll('.page');
            const prevBtns = document.querySelectorAll('.prev-btn');
            const nextBtns = document.querySelectorAll('.next-btn');
            const tocBtn = document.querySelector('.toc-btn');
            const tocPanel = document.querySelector('.toc-panel');
            const tocClose = document.querySelector('.toc-close');
            const tocItems = document.querySelectorAll('.toc-item');
            const bookmarkBtn = document.querySelector('.bookmark-btn');
            const fontIncreaseBtn = document.querySelector('.font-increase-btn');
            const fontDecreaseBtn = document.querySelector('.font-decrease-btn');
            const modeBtn = document.querySelector('.mode-btn');
            const homeBtn = document.querySelector('.home-btn');
            const resumeBtn = document.querySelector('.resume-btn');
            const progressBtn = document.querySelector('.progress-btn');
            const openBookBtn = document.querySelector('.open-book-btn');
            const pageTurnSound = document.getElementById('pageTurnSound');
            const paperSound = document.getElementById('paperSound');
            const typingSound = document.getElementById('typingSound');
            const loadingParchments = document.querySelectorAll('.loading-parchment');
            const progressContainer = document.querySelector('.progress-container');
            const progressBar = document.querySelector('.progress-bar');
            const pageJumpModal = document.querySelector('.page-jump-modal');
            const pageJumpInput = document.querySelector('.page-jump-input');
            const pageJumpGo = document.querySelector('.page-jump-button.go');
            const pageJumpCancel = document.querySelector('.page-jump-button.cancel');
            const settingsPanel = document.querySelector('.settings-panel');
            const typingSpeedInput = document.getElementById('typing-speed');
            const animationSpeedInput = document.getElementById('animation-speed');
            const saveSettingsBtn = document.querySelector('.settings-button.save');
            const cancelSettingsBtn = document.querySelector('.settings-button.cancel');
            const pageEdges = document.querySelectorAll('.page-left-edge, .page-right-edge');
            const pageNumbers = document.querySelectorAll('.page-number');

            // State variables
            let currentPageIndex = 0;
            let isAnimating = false;
            let bookmarkedPage = null;
            let fontSize = localStorage.getItem('fontSize') || 1;
            let isNightMode = localStorage.getItem('nightMode') === 'true';
            let typingSpeed = localStorage.getItem('typingSpeed') || 30;
            let animationSpeed = localStorage.getItem('animationSpeed') || 1000;
            let lastReadPage = localStorage.getItem('lastPageIndex') || 0;
            let touchStartX = 0;
            let touchEndX = 0;
            let soundsEnabled = true;
            let typingElements = [];

            // Initialize
            if (isNightMode) {
                document.body.classList.add('night-mode');
            }
            applyFontSize();
            updateActivePage();
            createInkStains();
            updateProgressBar();
            setupTypingSpeed();
            setupAnimationSpeed();
            
            // Set max page number in jump input
            pageJumpInput.max = pages.length - 1;
            
            // Event listeners
            openBookBtn.addEventListener('click', goToFirstPage);
            
            prevBtns.forEach(btn => btn.addEventListener('click', goToPrevPage));
            nextBtns.forEach(btn => btn.addEventListener('click', goToNextPage));
            
            tocBtn.addEventListener('click', toggleToc);
            tocClose.addEventListener('click', toggleToc);
            
            tocItems.forEach(item => {
                item.addEventListener('click', function() {
                    const pageId = this.getAttribute('data-page');
                    goToPage(pageId);
                    toggleToc();
                });
            });
            
            bookmarkBtn.addEventListener('click', toggleBookmark);
            fontIncreaseBtn.addEventListener('click', increaseFontSize);
            fontDecreaseBtn.addEventListener('click', decreaseFontSize);
            modeBtn.addEventListener('click', toggleNightMode);
            homeBtn.addEventListener('click', goToFirstPage);
            resumeBtn.addEventListener('click', resumeReading);
            progressBtn.addEventListener('click', showPageJumpModal);
            pageJumpGo.addEventListener('click', jumpToPage);
            pageJumpCancel.addEventListener('click', hidePageJumpModal);
            progressBtn.addEventListener('click', toggleProgressBar);
            progressContainer.addEventListener('click', function(e) {
                if (e.target === this) {
                    const rect = this.getBoundingClientRect();
                    const pos = (e.clientX - rect.left) / rect.width;
                    const pageNum = Math.round(pos * (pages.length - 1));
                    goToPageIndex(pageNum);
                }
            });

            // Page edge click handlers
            pageEdges.forEach(edge => {
                edge.addEventListener('click', function() {
                    if (this.classList.contains('page-left-edge')) {
                        goToPrevPage();
                    } else {
                        goToNextPage();
                    }
                });
            });

            // Page number click handlers
            pageNumbers.forEach(number => {
                number.addEventListener('click', function() {
                    const pageNum = parseInt(this.textContent);
                    goToPageIndex(pageNum - 1); // Convert to 0-based index
                });
            });

            // Settings panel
            progressBtn.addEventListener('dblclick', showSettingsPanel);
            typingSpeedInput.addEventListener('input', updateTypingSpeedDisplay);
            animationSpeedInput.addEventListener('input', updateAnimationSpeedDisplay);
            saveSettingsBtn.addEventListener('click', saveSettings);
            cancelSettingsBtn.addEventListener('click', hideSettingsPanel);

            // Touch events for mobile swipe
            bookContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
            bookContainer.addEventListener('touchmove', handleTouchMove, { passive: false });
            bookContainer.addEventListener('touchend', handleTouchEnd, { passive: true });

            // Keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowLeft') {
                    goToPrevPage();
                } else if (e.key === 'ArrowRight') {
                    goToNextPage();
                } else if (e.key === 'Escape') {
                    hidePageJumpModal();
                    hideSettingsPanel();
                }
            });

            // Play paper sound on first interaction
            document.addEventListener('click', function firstInteraction() {
                if (soundsEnabled) {
                    try {
                        paperSound.volume = 0.3;
                        paperSound.play();
                    } catch (e) {
                        console.log("Audio playback prevented:", e);
                        soundsEnabled = false;
                    }
                }
                document.removeEventListener('click', firstInteraction);
            }, { once: true });

            // Functions
            function updateActivePage() {
                pages.forEach((page, index) => {
                    page.classList.remove('active', 'flipped');
                    if (index === currentPageIndex) {
                        page.classList.add('active');
                        // Show loading animation briefly
                        const loader = page.querySelector('.loading-parchment');
                        loader.classList.add('active');
                        setTimeout(() => {
                            loader.classList.remove('active');
                            // Start typing animation for this page
                            startTypingAnimation(page);
                        }, 800);
                    } else if (index < currentPageIndex) {
                        page.classList.add('flipped');
                    }
                });
                
                // Update bookmark button state
                updateBookmarkButton();
                updateProgressBar();
                
                // Store last read page
                localStorage.setItem('lastPageIndex', currentPageIndex);
            }

            function startTypingAnimation(page) {
                // Clear any existing typing animations
                typingElements.forEach(el => {
                    if (el.typingInterval) {
                        clearInterval(el.typingInterval);
                    }
                });
                typingElements = [];
                
                // Get all elements with data-typing attribute
                const elements = page.querySelectorAll('[data-typing]');
                
                elements.forEach(el => {
                    if (el.dataset.typed) return; // Skip if already typed
                    
                    const originalText = el.textContent;
                    el.textContent = '';
                    el.style.visibility = 'visible';
                    
                    let i = 0;
                    const speed = parseInt(typingSpeed) + (Math.random() * 20 - 10);
                    const typingObj = { element: el, typingInterval: null };
                    typingElements.push(typingObj);
                    
                    const type = () => {
                        if (i < originalText.length) {
                            el.textContent += originalText.charAt(i);
                            i++;
                            
                            // Play typing sound randomly
                            if (soundsEnabled && Math.random() > 0.7) {
                                try {
                                    typingSound.currentTime = 0;
                                    typingSound.volume = 0.1;
                                    typingSound.play();
                                } catch (e) {
                                    console.log("Audio error:", e);
                                }
                            }
                            
                            typingObj.typingInterval = setTimeout(type, speed);
                        } else {
                            el.dataset.typed = "true";
                        }
                    };
                    
                    type();
                });
            }

            function goToPrevPage() {
                if (isAnimating || currentPageIndex <= 0) return;
                
                isAnimating = true;
                const currentPage = pages[currentPageIndex];
                const prevPage = pages[currentPageIndex - 1];
                
                playPageTurnSound();
                currentPage.classList.add('flipping');
                prevPage.classList.add('active');
                
                setTimeout(() => {
                    currentPage.classList.remove('active');
                    currentPage.classList.remove('flipping');
                    currentPage.classList.add('flipped');
                    currentPageIndex--;
                    isAnimating = false;
                }, animationSpeed);
            }

            function goToNextPage() {
                if (isAnimating || currentPageIndex >= pages.length - 1) return;
                
                isAnimating = true;
                const currentPage = pages[currentPageIndex];
                const nextPage = pages[currentPageIndex + 1];
                
                playPageTurnSound();
                nextPage.classList.add('active');
                
                if (currentPageIndex > 0) {
                    const prevPage = pages[currentPageIndex - 1];
                    prevPage.classList.remove('flipped');
                }
                
                currentPageIndex++;
                isAnimating = false;
                updateActivePage();
            }

            function goToPage(pageId) {
                const pageIndex = Array.from(pages).findIndex(page => page.id === pageId);
                if (pageIndex !== -1 && pageIndex !== currentPageIndex) {
                    goToPageIndex(pageIndex);
                }
            }

            function goToPageIndex(pageIndex) {
                if (pageIndex < 0 || pageIndex >= pages.length) return;
                
                playPageTurnSound();
                currentPageIndex = pageIndex;
                updateActivePage();
                hidePageJumpModal();
            }

            function goToFirstPage() {
                if (currentPageIndex !== 0) {
                    goToPageIndex(0);
                }
            }

            function resumeReading() {
                const lastPage = localStorage.getItem('lastPageIndex');
                if (lastPage && lastPage > 0) {
                    goToPageIndex(parseInt(lastPage));
                }
            }

            function toggleToc() {
                tocPanel.classList.toggle('active');
                playPaperSound();
            }

            function toggleBookmark() {
                if (bookmarkedPage === currentPageIndex) {
                    bookmarkedPage = null;
                    localStorage.removeItem('bookmarkedPage');
                } else {
                    bookmarkedPage = currentPageIndex;
                    localStorage.setItem('bookmarkedPage', bookmarkedPage);
                }
                updateBookmarkButton();
                playPaperSound();
            }

            function updateBookmarkButton() {
                if (bookmarkedPage === currentPageIndex) {
                    bookmarkBtn.style.backgroundColor = '#8a7a66';
                    bookmarkBtn.title = 'Remove bookmark';
                } else {
                    bookmarkBtn.style.backgroundColor = 'var(--highlight-color)';
                    bookmarkBtn.title = 'Bookmark page';
                }
            }

            function increaseFontSize() {
                if (fontSize < 1.5) {
                    fontSize = Math.round((fontSize + 0.1) * 10) / 10;
                    applyFontSize();
                    localStorage.setItem('fontSize', fontSize);
                    playPaperSound();
                }
            }

            function decreaseFontSize() {
                if (fontSize > 0.7) {
                    fontSize = Math.round((fontSize - 0.1) * 10) / 10;
                    applyFontSize();
                    localStorage.setItem('fontSize', fontSize);
                    playPaperSound();
                }
            }

            function applyFontSize() {
                document.querySelectorAll('.page-content').forEach(content => {
                    content.style.fontSize = `${fontSize}em`;
                });
            }

            function toggleNightMode() {
                document.body.classList.toggle('night-mode');
                isNightMode = !isNightMode;
                localStorage.setItem('nightMode', isNightMode);
                playPaperSound();
            }

            function handleTouchStart(e) {
                touchStartX = e.changedTouches[0].screenX;
            }

            function handleTouchMove(e) {
                if (!isAnimating) {
                    const touchX = e.touches[0].clientX;
                    const deltaX = touchStartX - touchX;
                    
                    if (deltaX > 20) {
                        // Swipe left - next page
                        goToNextPage();
                        touchStartX = touchX;
                        e.preventDefault();
                    } else if (deltaX < -20) {
                        // Swipe right - prev page
                        goToPrevPage();
                        touchStartX = touchX;
                        e.preventDefault();
                    }
                }
            }

            function handleTouchEnd(e) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }

            function handleSwipe() {
                const difference = touchStartX - touchEndX;
                if (difference > 50) {
                    goToNextPage();
                } else if (difference < -50) {
                    goToPrevPage();
                }
            }

            function createInkStains() {
                // Add random ink stains to pages
                const pagesWithContent = document.querySelectorAll('.page-content');
                pagesWithContent.forEach(page => {
                    // Create 1-3 ink stains per page
                    const stainCount = Math.floor(Math.random() * 3) + 1;
                    for (let i = 0; i < stainCount; i++) {
                        const stain = document.createElement('div');
                        stain.className = 'ink-stain';
                        
                        // Random position and size
                        const size = Math.random() * 50 + 20;
                        const left = Math.random() * 80 + 10;
                        const top = Math.random() * 80 + 10;
                        
                        stain.style.width = `${size}px`;
                        stain.style.height = `${size * (0.5 + Math.random())}px`;
                        stain.style.left = `${left}%`;
                        stain.style.top = `${top}%`;
                        stain.style.opacity = 0.03 + Math.random() * 0.07;
                        stain.style.transform = `rotate(${Math.random() * 360}deg)`;
                        
                        page.appendChild(stain);
                    }
                });
            }

            function playPageTurnSound() {
                if (soundsEnabled) {
                    try {
                        pageTurnSound.currentTime = 0;
                        pageTurnSound.volume = 0.2;
                        pageTurnSound.play();
                    } catch (e) {
                        console.log("Audio playback prevented:", e);
                        soundsEnabled = false;
                    }
                }
            }

            function playPaperSound() {
                if (soundsEnabled) {
                    try {
                        paperSound.currentTime = 0;
                        paperSound.volume = 0.1;
                        paperSound.play();
                    } catch (e) {
                        console.log("Audio playback prevented:", e);
                        soundsEnabled = false;
                    }
                }
            }

            function updateProgressBar() {
                const progress = (currentPageIndex / (pages.length - 1)) * 100;
                progressBar.style.width = `${progress}%`;
            }

            function toggleProgressBar() {
                progressContainer.style.display = progressContainer.style.display === 'block' ? 'none' : 'block';
                playPaperSound();
            }

            function showPageJumpModal() {
                pageJumpInput.value = currentPageIndex + 1; // Show 1-based index
                pageJumpModal.style.display = 'block';
                playPaperSound();
            }

            function hidePageJumpModal() {
                pageJumpModal.style.display = 'none';
            }

            function jumpToPage() {
                const pageNum = parseInt(pageJumpInput.value);
                if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= pages.length) {
                    goToPageIndex(pageNum - 1); // Convert to 0-based index
                }
            }

            function showSettingsPanel() {
                typingSpeedInput.value = typingSpeed;
                animationSpeedInput.value = animationSpeed;
                updateTypingSpeedDisplay();
                updateAnimationSpeedDisplay();
                settingsPanel.style.display = 'block';
                playPaperSound();
            }

            function hideSettingsPanel() {
                settingsPanel.style.display = 'none';
            }

            function updateTypingSpeedDisplay() {
                const speed = parseInt(typingSpeedInput.value);
                let speedText = '';
                if (speed < 20) speedText = 'Very Fast';
                else if (speed < 40) speedText = 'Fast';
                else if (speed < 60) speedText = 'Medium';
                else if (speed < 80) speedText = 'Slow';
                else speedText = 'Very Slow';
                
                typingSpeedInput.nextElementSibling.textContent = speedText;
            }

            function updateAnimationSpeedDisplay() {
                const speed = parseInt(animationSpeedInput.value);
                let speedText = '';
                if (speed < 800) speedText = 'Fast';
                else if (speed < 1200) speedText = 'Normal';
                else speedText = 'Slow';
                
                animationSpeedInput.nextElementSibling.textContent = speedText;
            }

            function saveSettings() {
                typingSpeed = parseInt(typingSpeedInput.value);
                animationSpeed = parseInt(animationSpeedInput.value);
                localStorage.setItem('typingSpeed', typingSpeed);
                localStorage.setItem('animationSpeed', animationSpeed);
                hideSettingsPanel();
                playPaperSound();
            }

            function setupTypingSpeed() {
                if (localStorage.getItem('typingSpeed')) {
                    typingSpeed = parseInt(localStorage.getItem('typingSpeed'));
                }
                document.documentElement.style.setProperty('--typing-speed', `${typingSpeed}ms`);
            }

            function setupAnimationSpeed() {
                if (localStorage.getItem('animationSpeed')) {
                    animationSpeed = parseInt(localStorage.getItem('animationSpeed'));
                }
                // Animation speed is applied in the goToPrevPage/goToNextPage functions
            }

            // Check for bookmarked page
            const savedBookmark = localStorage.getItem('bookmarkedPage');
            if (savedBookmark) {
                bookmarkedPage = parseInt(savedBookmark);
                updateBookmarkButton();
            }
        });
    </script>
</body>
</html>